# UniteDefi CLI Tests

このディレクトリには、UniteDefi CLIの包括的なテストスイートが含まれています。

## テスト構造

### 1. 基本CLIテスト (`cli_tests.rs`)
- HTLCコマンドの基本的な動作テスト
- 無効な秘密でのクレームテスト
- 存在しないHTLCの処理

### 2. 注文CLIテスト (`order_cli_tests.rs`)
- 注文作成コマンドのテスト
- 無効なアドレスでのエラーハンドリング

### 3. 注文管理テスト (`order_management_tests.rs`)
- 注文ステータスの確認
- 注文のキャンセル
- オーダーブックの表示
- 単体テストを含む

### 4. リレー注文テスト (`relay_order_tests.rs`)
- リレー注文コマンドの引数検証
- 非同期ハンドラーのテスト

### 5. 包括的CLIテスト (`comprehensive_cli_tests.rs`)
すべてのCLIコマンドの詳細なテスト：
- `create-htlc` - HTLC作成
- `claim` - HTLCクレーム
- `refund` - HTLC返金
- `order create` - 限価注文作成
- `order create-near` - NEAR注文作成
- `order status` - 注文ステータス確認
- `order cancel` - 注文キャンセル
- `orderbook` - オーダーブック表示
- `relay-order` - 注文リレー
- ヘルプとバージョン表示

### 6. データ整合性テスト (`data_integrity_tests.rs`)
- HTLC IDの一意性
- シークレットハッシュの整合性
- EIP-712ハッシュフォーマット
- 注文ソルトの一意性
- 価格計算の検証
- JSONフォーマットの一貫性
- タイムアウト値の検証
- 金額の境界値テスト

### 7. エラーハンドリングテスト (`error_handling_tests.rs`)
- 無効なコマンド
- 必須引数の欠落
- 無効なフォーマット（アドレス、金額、ハッシュ）
- 負の値の処理
- オーバーフロー処理
- 特殊文字とUnicodeの処理
- 並行実行の安全性

## テストの実行

### すべてのテストを実行
```bash
cargo test --workspace
```

### 特定のテストスイートを実行
```bash
cargo test --test comprehensive_cli_tests
```

### テストランナースクリプトを使用
```bash
./tests/test_runner.sh
```

### 詳細な出力付きでテスト実行
```bash
cargo test -- --nocapture
```

## 注意事項

### ストレージの永続性
現在の実装では、各CLIコマンドは独立したプロセスとして実行されるため、インメモリストレージはコマンド間で共有されません。そのため、一部の統合テストは`#[ignore]`属性でマークされています。

### テストの並行実行
Rustのテストランナーはデフォルトで並行実行されます。ストレージの競合を避けるため、各テストは独自のデータを使用します。

## テストカバレッジ

テストは以下の領域をカバーしています：

1. **正常系パス**: すべてのコマンドの期待される動作
2. **エラー処理**: 無効な入力、欠落データ、境界条件
3. **データ検証**: フォーマット、一意性、整合性
4. **並行性**: 複数のコマンドの同時実行
5. **ヘルプシステム**: ヘルプとバージョン情報の表示

## 今後の改善点

1. **永続ストレージ**: ファイルベースまたはデータベースストレージの実装
2. **統合テスト**: 実際のブロックチェーンとの統合テスト
3. **パフォーマンステスト**: 大量データでのベンチマーク
4. **セキュリティテスト**: 暗号化操作の検証