# 1inch Fusion 完全理解ガイド

## 📌 はじめに

1inch Fusionは、従来のDEXとは全く異なる「インテントベース」の取引システムです。ユーザーは「何をしたいか」を宣言するだけで、実行はプロのリゾルバーが競争的に行います。

## 🎯 Fusionの核心概念

### 1. インテントベース取引

従来のDEX。

```text
ユーザー「0.1 ETHを使って、最低100 USDCを得たい」
→ ユーザー自身がトランザクションを実行
→ ガス代をユーザーが支払う
```

Fusion。

```text
ユーザー「0.1 ETHを100 USDCに交換したい」（署名するだけ）
→ リゾルバーが競争して最良レートを提供
→ ガス代はリゾルバーが支払う
```

### 2. Dutch Auction（ダッチオークション）

時間の経過とともに価格が変化し、リゾルバーに利益が出る仕組みです。

```text
開始時：100 USDC（ユーザーに有利）
    ↓
時間経過
    ↓
終了時：98 USDC（リゾルバーに有利）
```

## 📊 Fusionの主要コンポーネント

### 1. FusionOrder（注文）

```typescript
const order = FusionOrder.new(
    extensionContract,
    {
        makerAsset: "WETH",      // 売りたいトークン
        takerAsset: "USDC",      // 買いたいトークン
        makingAmount: "1 ETH",   // 売る量
        takingAmount: "1420 USDC", // 最低限欲しい量
        maker: "0x...",          // ユーザーアドレス
        salt: 10n                // 一意性を保証する値
    },
    {
        auction: auctionDetails,  // オークション設定
        whitelist: whitelist      // リゾルバー制限
    }
)
```

### 2. AuctionDetails（オークション詳細）

```typescript
const auctionDetails = new AuctionDetails({
    duration: 180n,           // オークション期間（秒）
    startTime: 1673548149n,   // 開始時刻（Unix timestamp）
    initialRateBump: 50000,   // 初期価格ボーナス（5%）
    points: [                 // 価格カーブの定義
        {
            delay: 10,        // 開始から10秒後
            coefficient: 40000 // 4%のボーナス
        },
        {
            delay: 10,        // さらに10秒後（計20秒）
            coefficient: 40000 // 4%のボーナス
        }
    ]
})
```

### 価格カーブの視覚的理解

```text
価格ボーナス率
    ▲
5%  │\
    │ \
4%  │  \───────
    │          \
3%  │           \
    │            \
2%  │             \
    │              \
    └─────────────────────────►
    0   10     20  180秒   時間
```

### 3. Whitelist（ホワイトリスト）

特定のリゾルバーに優先実行権を与える仕組みです。

```typescript
const whitelist = Whitelist.new(
    resolvingStartTime,
    [
        {
            address: "0x111...",  // 優先リゾルバー1
            allowFrom: resolvingStartTime  // すぐに実行可能
        },
        {
            address: "0x222...",  // 一般リゾルバー
            allowFrom: resolvingStartTime + 10n  // 10秒後から実行可能
        }
    ]
)
```

## 🔄 Fusionの実行フロー

### ステップ1：注文作成

1. ユーザーがFusionOrderを作成
2. オフチェインで署名（ガス代不要）
3. 1inchのリレーヤーに送信

### ステップ2：オークション開始

1. リレーヤーが全リゾルバーに注文を配信
2. Dutch Auctionが開始
3. 価格が時間とともに変化

### ステップ3：リゾルバーの競争

1. 各リゾルバーが利益計算
2. 利益が出るタイミングで実行を試みる
3. 最初に成功したリゾルバーが勝利

### ステップ4：実行

1. リゾルバーがトランザクションを送信
2. ユーザーのトークンをスワップ
3. 結果をユーザーに送付

## 💡 重要な特徴

### 1. ガスレス取引

- ユーザーはガス代を支払わない
- リゾルバーがガス代を負担
- ガスコストは価格に反映される

### 2. MEV保護

- オークションメカニズムにより公平な価格発見
- フロントランニングが困難
- リゾルバー間の競争により最適価格

### 3. 部分約定

大口注文を複数の小さな注文に分割可能。

```text
1000 ETH → 250 ETH × 4回
各部分に異なるシークレットを使用
```

### 4. 失敗時の保護

- タイムアウト設定
- キャンセル可能
- 資金の安全性が保証される

## 🔑 なぜFusionが革新的なのか

1. ユーザー体験の向上
   - 署名するだけで完了
   - ガス代不要
   - 最良価格を自動的に獲得

2. リゾルバーエコシステム
   - プロのマーケットメーカーが参加
   - 競争による市場
   - KYC済みで信頼性が高い

3. スケーラビリティ
   - オフチェイン注文管理
   - オンチェイン実行の最適化
   - 高頻度取引に対応

## 📝 まとめ

1inch Fusionは、ユーザーの「意図（インテント）」と「実行」を分離することで、DEXの新しいパラダイムを作り出しました。ユーザーは取引の詳細を気にすることなく、最良の結果を得ることができます。

次のステップ：このFusionの仕組みをクロスチェイン（Fusion+）に拡張する方法を理解していきます。
