# HTLCアトミックスワップの詳細フロー図

## 🎯 重要：すべてパブリックブロックチェイン上で実行

```text
秘密の実行環境は不要！
✅ 通常のサーバー
✅ ローカルPC
✅ クラウド環境
❌ TEE不要
❌ 特殊なハードウェア不要
```

## 📊 完全な実行フロー

```text
時間軸 →

[準備フェーズ]
├─ リゾルバーがオーダーを受信
├─ 利益計算（Dutch Auction価格）
└─ 実行判断

[フェーズ1: セットアップ] t=0
├─ CLIツール: シークレット生成
│   secret = random(32 bytes)
│   hash = SHA256(secret)
└─ 両チェーンへの接続確認

[フェーズ2: NEAR側エスクロー作成] t=1分
├─ リゾルバー: NEARエスクロー作成
│   - 100 NEARをロック
│   - hash をセット
│   - タイムアウト設定
└─ トランザクション確認待機

[フェーズ3: Ethereum側エスクロー作成] t=3分
├─ ユーザー: ETHエスクロー作成
│   - 1 ETHをロック
│   - 同じhashをセット
│   - より短いタイムアウト
└─ トランザクション確認待機

[フェーズ4: シークレット公開] t=5分
├─ CLIツール: 両エスクロー確認
├─ NEAR側でsecret公開
│   → ユーザーが100 NEAR受取
└─ Ethereum側でも同じsecret使用
    → リゾルバーが1 ETH受取

[完了] t=10分
```

## 🔐 セキュリティの仕組み

### なぜ安全なのか

```text
1. ハッシュの一方向性
   secret → hash ✅ 簡単
   hash → secret ❌ 不可能（SHA-256）

2. タイムアウトの保証
   Ethereum: 20分後にユーザーへ返金
   NEAR: 30分後にリゾルバーへ返金

3. アトミック性
   両方成功 OR 両方失敗
   片方だけは数学的に不可能
```

### 攻撃シナリオと防御

```text
攻撃1: リゾルバーがNEARエスクローを作らない
→ ユーザーはETHエスクローを作らない（防御成功）

攻撃2: ユーザーがETHエスクローを作らない
→ リゾルバーはタイムアウト後にNEARを回収（防御成功）

攻撃3: シークレットを公開しない
→ 両方タイムアウトで返金（防御成功）

攻撃4: 間違ったシークレット
→ ハッシュが一致しないので失敗（防御成功）
```

## 💻 実装の単純さ

### 従来のブリッジ

```text
必要な知識：
- コンセンサスアルゴリズム
- ライトクライアント実装
- Merkle Tree/Patricia Tree
- 閾値署名
- チャレンジ・レスポンス
- ガバナンストークン
```

### HTLCアトミックスワップ

```text
必要な知識：
- ハッシュ関数（SHA-256）
- タイマー
- 基本的なスマートコントラクト
```

## 実行環境の要件

### 最小要件

```yaml
リゾルバー環境:
  CPU: 1 core
  RAM: 1 GB
  Storage: 10 GB
  Network: 通常のインターネット
  特殊要件: なし

ソフトウェア:
  - Node.js 16+
  - 両チェーンのRPCエンドポイント
  - ウォレット（秘密鍵）
```

### 推奨構成

```yaml
本番環境:
  - 冗長性のためのマルチリージョン
  - 監視・アラート
  - 自動リトライ
  - ロギング

それでも従来ブリッジの1/100のコスト
```

## 🎮 ユーザー体験

### ユーザー視点

```text
1. 1inch UIでスワップ注文
   「1 ETH → 100 NEAR」

2. メタマスクで署名
   （通常のDeFi操作と同じ）

3. 待機（5-10分）
   プログレスバー表示

4. NEARウォレットに着金
   通知：「100 NEAR received!」
```

### 裏側で起きていること

```text
自動化されたCLIツールが：
- 最適なリゾルバーを選択
- エスクロー作成を調整
- シークレット管理
- タイムアウト監視
- エラーハンドリング
```

## 🏆 ハッカソンでのアピールポイント

```text
従来手法の問題：
「ブリッジハック総額：$2B+」
「開発期間：6-12ヶ月」
「運用コスト：年間$1M+」

私たちのソリューション：
「ハック不可能（数学的保証）」
「開発期間：2週間」
「運用コスト：ほぼゼロ」

デモ：
1. コマンド実行
2. 5分待つ
3. スワップ完了！

シンプル・安全・高速
```

これでTEE不要、信頼不要、そして実装可能なクロスチェインスワップの全体像が明確になりました。
