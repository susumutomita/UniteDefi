# 1inch Fusion+ 技術ガイド

## 📺 ワークショップサマリー
ソース: [1inch Cross-chain Swap Workshop by Tanner Moore](https://www.youtube.com/watch?v=W2xCf-TCnwc)

## 🔧 1inch製品スイート概要

### 1. クラシックスワップ
- 目的: AMM/PMMアグリゲーション
- 機能:
  - 複数のプロトコルから流動性を集約（Uniswap、Curve、SushiSwapなど）
  - スワップ出力とガス料金を最適化
  - 単一トランザクション実行
  - 例: USDC→DAIで複数のDEXを横断した最適ルートを発見

### 2. 1inch Fusion（インテントベーススワップ）

- 解決する問題: MEV攻撃、ガス料金、失敗したトランザクション
- 動作方法:
  1. ユーザーがスワップリクエストへ署名
  2. ダッチオークション開始（価格は市場価格より高く始まり、徐々に減少）
  3. 価格が最適なタイミングで勝者がスワップを実行する
- 利点:
  - MEV保護
  - ユーザーのガスレストランザクション
  - リゾルバー競争によるより良いレート

### 3. 1inch Fusion+（クロスチェインスワップ）
- 基盤: Fusion技術
- 主要機能:
  - クロスブロックチェインスワップ
  - トラストレス実行
  - シンプルなUX
  - 良好なスワップレート

## 🔐 ハッシュタイムロックコントラクト（HTLC）アーキテクチャ

### コアコンセプト
HTLCは以下を行うスマートコントラクト。
- エスクローに資金を保持
- 正しい「シークレット」が提供された場合のみ資金を解放
- タイムアウトが切れた場合、資金を送信者に返還

### Fusion+実装フロー

```
1. ユーザーリクエスト: Ethereum USDC → Base DAI
   ↓
2. 1inch APIがダッチオークションを開始
   ↓
3. リゾルバーがオークションに勝ち、エスクローコントラクトを作成
   ↓
4. セーフティデポジット:
   - リゾルバーが両方のチェーン（Ethereum & Base）にデポジット
   - トランザクション完了インセンティブを確保
   ↓
5. 資金移動:
   - ユーザー資金 → ソースチェーンエスクロー（Ethereum）
   - リゾルバー資金 → 宛先チェーンエスクロー（Base）
   ↓
6. リレイヤーサービス:
   - 両方のエスクローコントラクトを監視
   - 資金デポジットを検証
   - シークレット共有を促進
   ↓
7. シークレット共有:
   - ユーザーがリレイヤーとシークレットを共有
   - リレイヤーがリゾルバーと共有
   - シークレットはすべてのリゾルバーに公開
   ↓
8. 完了:
   - 元のリゾルバーがスワップを完了 または
   - 他のリゾルバーが完了可能（セーフティデポジット獲得）
```

### 安全メカニズム
- 元のリゾルバーが失敗した場合、他のリゾルバーがスワップを完了できる
- セーフティデポジットが完了を促進
- 単一障害点なし

## 🎯 ハッカソン要件

### 主要課題
EVMチェインと非EVMチェイン間のHTLCと通信を管理。

### コア要件
1. 非EVM実装でハッシュロックとタイムロック機能を保持
2. 双方向スワップ: EVM↔非EVM
3. オンチェイントークン転送デモ（メインネットまたはテストネット）
4. 1inchエスクローファクトリーと公式コントラクトを使用

### ストレッチゴール（オプションだが推奨）
1. UI作成: スワップ対話のためのユーザーインタフェース
2. 部分フィル: 部分注文充填のための複数シークレット有効化
3. リレイヤー/リゾルバー実装: 1inchデザインに合わせた非EVMチェイン用
4. メインネットデプロイ: 本番準備完了の実装

## ⚠️ 重要なハッカソン注意事項

### してはいけないこと:
- 公式REST APIに注文を投稿（KYC/ホワイトリスト必要）
- 1inchの本番リゾルバーに依存

### すべきこと:
- スマートコントラクトレベルで作業
- 自分でトランザクションを完了
- 提供されたサンプルリポジトリを使用
- まずテストネットで徹底的にテスト

## 🛠️ 技術リソース

### サンプルリポジトリ
- 名前: `crosschain-resolver-example`
- 言語: TypeScript
- 目的: Ethereum↔BNBチェインFusion+スワップをシミュレート
- 内容:
  - スマートコントラクト対話例
  - セーフティデポジット実装
  - エスクローコントラクト使用法

### ハッカソンガイド
- URL: hackathon.1inch.community（Notion）
- 内容:
  - チートシート
  - ドキュメントリンク
  - APIキー取得
  - Discordサポート

### APIアクセス
- プロモコード利用可能: ハッカソン参加者向け
- 利点:
  - ハッカソン期間中KYC不要
  - 60 RPM（1分あたりのリクエスト）
  - 500,000 Web3 RPCコール
  - 無料Dev portalアクセス

## 🔑 主要な技術的洞察

### ダッチオークション設定
- 作成時に多くの場合制御可能
- オプション:
  - 静的価格
  - 時間ベースの価格減衰
  - カスタム価格カーブ

### リレイヤーサービス
- 現在1inchが管理
- 将来の分散化計画
- クロスチェイン調整に重要

### 現在の制限
- APIはメインネットのみサポート（テストネットなし）
- 本番用リゾルバーホワイトリスト必要
- 公式API使用にKYC必要

## 💡 Rust CLI実装戦略

### 推奨アプローチ
1. TypeScriptサンプル研究: EVM側実装を理解
2. Rustへ移植: コアロジックのRust同等物を作成
3. 非EVMサポート追加: ターゲットチェイン用HTLCを実装
4. CLIインタフェース構築: テスト用コマンドラインツール
5. デモフロー作成: エンドツーエンドスワップデモンストレーション

### 実装すべき主要コンポーネント
```rust
// すべてのチェーン用のコアHTLCトレイト
trait HTLCContract {
    fn create_lock(&self, secret_hash: Hash, timeout: u64) -> Result<()>;
    fn claim_with_secret(&self, secret: Secret) -> Result<()>;
    fn refund_after_timeout(&self) -> Result<()>;
}

// チェーン固有の実装
impl HTLCContract for EthereumHTLC { ... }
impl HTLCContract for NearHTLC { ... }
impl HTLCContract for CosmosHTLC { ... }
```

### テスト戦略
1. ローカルブロックチェインテスト（Ganache、Nearサンドボックスなど）
2. テストネットデプロイと検証
3. クロスチェインスワップシミュレーション
4. エラーケース処理（タイムアウト、失敗したクレーム）

## 🎪 デモ準備

### 必要なデモ要素
1. ライブトランザクション: 実際のクロスチェインスワップを表示
2. シークレット管理: HTLCメカニクスをデモンストレーション
3. 双方向: EVM→非EVMと非EVM→EVMの両方
4. エラー回復: タイムアウト/払い戻しメカニズムを表示

### 推奨デモフロー
```bash
# 1. アカウントセットアップ
fusion-cli setup --source ethereum --destination near

# 2. 残高確認
fusion-cli balance --chain ethereum
fusion-cli balance --chain near

# 3. スワップ開始
fusion-cli swap --from ethereum --to near --amount 100 --token USDC

# 4. 進行状況監視
fusion-cli status --swap-id 0x123...

# 5. スワップ完了（シークレット公開）
fusion-cli complete --swap-id 0x123... --secret 0xabc...

# 6. 完了確認
fusion-cli balance --chain near
```

## 📚 追加リソース
- [1inch Developer Portal](https://docs.1inch.io/)
- [1inch GitHub](https://github.com/1inch)
- [Fusion+ Whitepaper](TBD)
- [Discord Support](hackathon.1inch.community経由)
