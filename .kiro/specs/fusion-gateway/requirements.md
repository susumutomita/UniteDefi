# 要件仕様書

## 概要
Fusion Gatewayは、1inch Fusion+プロトコルを拡張し、Ethereum（EVM）と非EVMチェーン（NEAR、Cosmos、Stellar）間でトラストレスなアトミックスワップを実現するCLIベースのゲートウェイシステムです。HTLC（Hash Time Locked Contract）パターンを活用し、クロスチェーン間での安全なトークン交換を提供します。

## 要件

### 要件1: コマンドラインインターフェース（CLI）の基本機能
**ユーザーストーリー:** 開発者として、シンプルで直感的なCLIコマンドを使用してクロスチェーンスワップを実行したい、これによりプログラマティックな統合とテストが容易になる

#### 受け入れ基準
1. WHEN ユーザーが`fusion-gateway --help`を実行 THEN 利用可能なすべてのコマンドと使用方法が表示される
2. WHEN ユーザーが`fusion-gateway swap create`を実行 THEN スワップ作成に必要なパラメータ（送信元チェーン、宛先チェーン、金額、タイムアウト）の入力を求められる
3. WHEN ユーザーが`fusion-gateway swap status <swap-id>`を実行 THEN 進行中のスワップの現在の状態が表示される
4. IF 無効なコマンドまたはパラメータが提供された THEN 明確でヘルプフルなエラーメッセージが表示される

### 要件2: EVMから非EVMチェーンへのスワップ
**ユーザーストーリー:** トレーダーとして、EthereumからNEAR/Cosmos/Stellarへのトークンスワップを実行したい、これにより中央集権的な取引所を使わずに資産を移動できる

#### 受け入れ基準
1. WHEN ユーザーがEthereumからNEARへのスワップを開始 THEN 1inch Fusion+エスクローコントラクトにトークンがロックされる
2. WHEN シークレットが公開された THEN NEARチェーン上でトークンが自動的に請求される
3. WHEN タイムアウト期間が経過した THEN Ethereum上でロックされたトークンが返金可能になる
4. IF NEARチェーンでの請求が失敗した THEN エラーがログに記録され、ユーザーに通知される
5. WHEN ユーザーがCosmosまたはStellarを宛先として選択 THEN 同様のフローがそれぞれのチェーンで実行される

### 要件3: クロスチェーンリレイヤーサービスの実装
**ユーザーストーリー:** システム運用者として、EthereumとNEAR/Cosmos/Stellar間でリミットオーダーを自動的に中継するリレイヤーサービスを実行したい、これによりユーザーは手動介入なしにクロスチェーン取引を実行できる

#### 受け入れ基準
1. WHEN リレイヤーが起動 THEN 設定されたすべてのチェーンのLimit Order Protocolコントラクトを監視開始する
2. WHEN Ethereumでリミットオーダーが作成された THEN 対応する非EVMチェーンで同等のオーダーが自動作成される
3. WHEN 非EVMチェーンでリミットオーダーが作成された THEN Ethereum上で対応するオーダーが自動作成される
4. WHEN 一方のチェーンでオーダーがフィルされた THEN 他方のチェーンで自動的に対応するフィル処理が実行される
5. IF リレイヤーが一時停止した THEN 再起動時に未処理のイベントが適切に同期される

### 要件4: コマンドラインインターフェース（CLI）の実装
**ユーザーストーリー:** 開発者として、シンプルで直感的なCLIコマンドを使用してクロスチェーンリミットオーダー取引を管理したい、これによりプログラマティックな統合とテストが容易になる

#### 受け入れ基準
1. WHEN ユーザーが`fusion-gateway --help`を実行 THEN 利用可能なすべてのコマンドと使用方法が表示される
2. WHEN ユーザーが`fusion-gateway order create`を実行 THEN リミットオーダー作成に必要なパラメータ（チェーン、トークンペア、価格、数量）の入力を求められる
3. WHEN ユーザーが`fusion-gateway order status <order-id>`を実行 THEN 指定されたオーダーの現在の状態（オープン、部分フィル、完了、キャンセル）が表示される
4. WHEN ユーザーが`fusion-gateway relayer start`を実行 THEN リレイヤーサービスがバックグラウンドで起動される
5. IF 無効なコマンドまたはパラメータが提供された THEN 明確でヘルプフルなエラーメッセージが表示される

### 要件5: クロスチェーンオーダーマッチング
**ユーザーストーリー:** トレーダーとして、Ethereum上のリミットオーダーと非EVMチェーン上のオーダーが自動的にマッチングされることを期待する、これによりクロスチェーン流動性を活用できる

#### 受け入れ基準
1. WHEN Ethereum上でETH/USDCのリミットオーダーが作成された THEN NEAR上で対応するNEAR/USDCオーダーが自動作成される
2. WHEN 価格条件が満たされた THEN 両チェーンで同時にオーダーフィル処理が実行される
3. WHEN 部分フィルが発生した THEN 残りの数量で新しいオーダーが両チェーンに作成される
4. IF 一方のチェーンでフィルが失敗した THEN 他方のチェーンでも対応するロールバック処理が実行される
5. WHEN オーダーがキャンセルされた THEN 対応するすべてのチェーンで同期的にキャンセル処理が実行される

### 要件6: オーダーブック管理とモニタリング
**ユーザーストーリー:** ユーザーとして、各チェーンのオーダーブック状態とクロスチェーンマッチング状況をリアルタイムで確認したい、これにより取引機会を適切に判断できる

#### 受け入れ基準
1. WHEN `fusion-gateway orderbook <chain>`コマンドが実行された THEN 指定チェーンの現在のオーダーブック（買い注文・売り注文）が表示される
2. WHEN `fusion-gateway orders list`コマンドが実行された THEN ユーザーのアクティブなオーダーがすべてのチェーンから集約表示される
3. WHEN オーダーの状態が変更された THEN タイムスタンプ付きでイベントログに記録される
4. WHEN `fusion-gateway relayer status`コマンドが実行された THEN リレイヤーの稼働状況と処理中のオーダー数が表示される
5. IF リレイヤーでエラーが発生した THEN 詳細なエラー情報とリカバリー手順が提供される

### 要件7: 設定管理とネットワーク対応
**ユーザーストーリー:** 開発者として、異なる環境（テストネット、メインネット）と複数のチェーンに対して簡単に設定を管理したい、これにより開発とデプロイメントが効率化される

#### 受け入れ基準
1. WHEN `fusion-gateway init`が実行された THEN すべてのサポートチェーン用のデフォルト設定ファイルが作成される
2. WHEN 環境変数が設定された THEN 設定ファイルの値より優先される
3. WHEN `--network testnet`フラグが使用された THEN すべてのチェーンでテストネット設定（RPCエンドポイント、コントラクトアドレス）が使用される
4. IF 必須の設定（RPCエンドポイント、秘密鍵、コントラクトアドレス）が欠落している THEN 明確なエラーメッセージが表示される
5. WHEN `fusion-gateway config validate`コマンドが実行された THEN すべてのチェーンの設定有効性とコントラクト接続がチェックされる

### 要件8: セキュリティとエラーハンドリング
**ユーザーストーリー:** ユーザーとして、クロスチェーン取引が失敗した場合でも資金が安全に保護され、適切なリカバリーオプションが提供されることを期待する

#### 受け入れ基準
1. WHEN ネットワークエラーが発生した THEN 自動的にリトライメカニズムが実行される（指数バックオフ付き）
2. WHEN 一方のチェーンでオーダー作成が失敗した THEN 他方のチェーンで作成済みのオーダーが自動キャンセルされる
3. IF リレイヤーが長時間応答しない THEN ユーザーに警告が表示され、手動でのオーダー管理オプションが提供される
4. WHEN 部分的なフィル後にエラーが発生した THEN 処理済み部分は保持され、残り部分のリカバリー手順が提供される
5. IF 致命的エラーが発生した THEN 詳細なエラーログが保存され、各チェーンの状態診断情報が生成される

### 要件9: パフォーマンスとスケーラビリティ
**ユーザーストーリー:** マーケットメーカーとして、複数の同時リミットオーダーを効率的に処理できるシステムが必要、これにより大量の取引を扱うことができる

#### 受け入れ基準
1. WHEN 10個の同時オーダーが作成された THEN すべてが並列処理され、個々のオーダーは相互に影響しない
2. WHEN RPCレート制限に達した THEN 自動的にリクエストがキューイングされ、制限内で処理される
3. WHEN リレイヤーが長時間実行された THEN メモリリークが発生せず、パフォーマンスが劣化しない
4. IF 一つのチェーンの応答が遅い THEN タイムアウトが適切に設定され、他のチェーンの処理がブロックされない
5. WHEN 大量のオーダーイベントが発生した THEN バッチ処理により効率的に処理される