# 要件仕様書

## 概要
Fusion Gatewayは、1inch Fusion+プロトコルを拡張し、Ethereum（EVM）と非EVMチェーン（NEAR、Cosmos、Stellar）間でトラストレスなアトミックスワップを実現するCLIベースのゲートウェイシステムです。HTLC（Hash Time Locked Contract）パターンを活用し、クロスチェーン間での安全なトークン交換を提供します。

## 要件

### 要件1: コマンドラインインターフェース（CLI）の基本機能
**ユーザーストーリー:** 開発者として、シンプルで直感的なCLIコマンドを使用してクロスチェーンスワップを実行したい、これによりプログラマティックな統合とテストが容易になる

#### 受け入れ基準
1. WHEN ユーザーが`fusion-gateway --help`を実行 THEN 利用可能なすべてのコマンドと使用方法が表示される
2. WHEN ユーザーが`fusion-gateway swap create`を実行 THEN スワップ作成に必要なパラメータ（送信元チェーン、宛先チェーン、金額、タイムアウト）の入力を求められる
3. WHEN ユーザーが`fusion-gateway swap status <swap-id>`を実行 THEN 進行中のスワップの現在の状態が表示される
4. IF 無効なコマンドまたはパラメータが提供された THEN 明確でヘルプフルなエラーメッセージが表示される

### 要件2: EVMから非EVMチェーンへのスワップ
**ユーザーストーリー:** トレーダーとして、EthereumからNEAR/Cosmos/Stellarへのトークンスワップを実行したい、これにより中央集権的な取引所を使わずに資産を移動できる

#### 受け入れ基準
1. WHEN ユーザーがEthereumからNEARへのスワップを開始 THEN 1inch Fusion+エスクローコントラクトにトークンがロックされる
2. WHEN シークレットが公開された THEN NEARチェーン上でトークンが自動的に請求される
3. WHEN タイムアウト期間が経過した THEN Ethereum上でロックされたトークンが返金可能になる
4. IF NEARチェーンでの請求が失敗した THEN エラーがログに記録され、ユーザーに通知される
5. WHEN ユーザーがCosmosまたはStellarを宛先として選択 THEN 同様のフローがそれぞれのチェーンで実行される

### 要件3: 非EVMからEVMチェーンへのスワップ
**ユーザーストーリー:** トレーダーとして、NEAR/Cosmos/StellarからEthereumへのトークンスワップを実行したい、これにより非EVMチェーンの資産をDeFiエコシステムに戻すことができる

#### 受け入れ基準
1. WHEN ユーザーがNEARからEthereumへのスワップを開始 THEN NEARチェーン上のHTLCコントラクトにトークンがロックされる
2. WHEN カスタムリレイヤーがNEARでのロックを検出 THEN Ethereum上で対応するオーダーが作成される
3. WHEN シークレットがEthereumで公開された THEN NEARチェーン上でトークンが自動的に請求される
4. IF タイムアウト期間が経過した THEN NEAR上でロックされたトークンが返金可能になる
5. WHEN ユーザーがCosmosまたはStellarを送信元として選択 THEN 同様のフローがそれぞれのチェーンで実行される

### 要件4: HTLCセキュリティメカニズム
**ユーザーストーリー:** ユーザーとして、スワップが失敗した場合でも資金が安全に保護されることを確実にしたい、これにより資金損失のリスクなくクロスチェーンスワップを実行できる

#### 受け入れ基準
1. WHEN HTLCが作成された THEN ユニークなシークレットハッシュが生成され、両方のチェーンで使用される
2. WHEN タイムロック期間が設定された THEN 送信元チェーンのタイムロックが宛先チェーンより十分に長い（最低2倍）
3. IF シークレットが公開されずにタイムアウトした THEN 両方のチェーンで自動的に返金プロセスが開始される
4. WHEN 部分的なフィル（partial fill）が有効な場合 THEN 複数のシークレットが生成され、段階的な実行が可能になる
5. IF 不正なシークレットが提供された THEN トランザクションが拒否され、資金は安全に保持される

### 要件5: リレイヤーサービス
**ユーザーストーリー:** スワップ参加者として、手動介入なしにクロスチェーン操作が自動的に実行されることを期待する、これによりシームレスなユーザー体験が提供される

#### 受け入れ基準
1. WHEN リレイヤーサービスが起動 THEN 設定されたすべてのチェーンのイベントが監視される
2. WHEN 新しいHTLCロックが検出された THEN 対応するチェーンで自動的にマッチングオーダーが作成される
3. WHEN シークレットが一方のチェーンで公開された THEN 他方のチェーンで自動的に請求トランザクションが送信される
4. IF リレイヤーが一時的に利用不可能になった THEN 再起動時に未処理のイベントが処理される
5. WHEN 複数の同時スワップが発生 THEN リレイヤーは並列処理でそれらを効率的に処理する

### 要件6: モニタリングとステータス追跡
**ユーザーストーリー:** ユーザーとして、進行中のスワップの状態をリアルタイムで確認したい、これにより問題を早期に発見し適切な対応ができる

#### 受け入れ基準
1. WHEN `swap status`コマンドが実行された THEN 現在のフェーズ（ロック済み、請求待ち、完了、タイムアウト）が表示される
2. WHEN スワップの状態が変更された THEN タイムスタンプ付きでイベントログに記録される
3. WHEN `swap list`コマンドが実行された THEN アクティブおよび最近完了したすべてのスワップが表示される
4. IF エラーが発生した THEN 詳細なエラー情報とリカバリー手順が提供される
5. WHEN `swap history`コマンドが実行された THEN 過去のすべてのスワップ履歴がフィルタリング可能な形式で表示される

### 要件7: 設定管理
**ユーザーストーリー:** 開発者として、異なる環境（テストネット、メインネット）に対して簡単に設定を管理したい、これにより開発とデプロイメントが効率化される

#### 受け入れ基準
1. WHEN `fusion-gateway init`が実行された THEN デフォルトの設定ファイルが作成される
2. WHEN 環境変数が設定された THEN 設定ファイルの値より優先される
3. WHEN `--network testnet`フラグが使用された THEN すべてのチェーンでテストネット設定が使用される
4. IF 必須の設定（RPCエンドポイント、秘密鍵）が欠落している THEN 明確なエラーメッセージが表示される
5. WHEN `config validate`コマンドが実行された THEN すべての設定の有効性がチェックされる

### 要件8: エラーハンドリングとリカバリー
**ユーザーストーリー:** ユーザーとして、トランザクションが失敗した場合でも適切なリカバリーオプションが提供されることを期待する、これにより資金の安全性が保証される

#### 受け入れ基準
1. WHEN ネットワークエラーが発生した THEN 自動的にリトライメカニズムが実行される（指数バックオフ付き）
2. WHEN ガス不足エラーが発生した THEN 推奨ガス設定と再実行方法が提示される
3. IF チェーンの同期問題が検出された THEN ユーザーに警告が表示され、安全な待機期間が提案される
4. WHEN 部分的な失敗が発生した（片方のチェーンのみ成功）THEN 手動リカバリー手順が提供される
5. IF 致命的エラーが発生した THEN 詳細なエラーログが保存され、サポート用の診断情報が生成される

### 要件9: パフォーマンスとスケーラビリティ
**ユーザーストーリー:** マーケットメーカーとして、複数の同時スワップを効率的に処理できるシステムが必要、これにより大量の取引を扱うことができる

#### 受け入れ基準
1. WHEN 10個の同時スワップが実行された THEN すべてが並列処理され、個々のスワップは相互に影響しない
2. WHEN RPCレート制限に達した THEN 自動的にリクエストがキューイングされ、制限内で処理される
3. WHEN 長時間実行された THEN メモリリークが発生せず、パフォーマンスが劣化しない
4. IF チェーンの応答が遅い THEN タイムアウトが適切に設定され、他のチェーンの処理がブロックされない
5. WHEN 大量のイベントが発生した THEN バッチ処理により効率的に処理される